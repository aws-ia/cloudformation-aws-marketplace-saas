// Replace the content in <>
// Briefly describe the software. Use consistent and clear branding. 
// Include the benefits of using the software on AWS, and provide details on usage scenarios.

The AWS Marketplace Serverless SaaS Integration solution fulfills the core capabilities required to successfully integrate a vendor SaaS solution with it’s corresponding listing on AWS Marketplace. These capabilities include accepting new customer registrations, granting and revoking customer access, updating customer entitlements, and reporting metered usage.

*Register new customers*

With SaaS subscriptions and SaaS contracts, your customers subscribe to your products through AWS Marketplace, but access the product on environment you manage in your AWS account. After subscribing to the product, your customer is directed to a product registration page you create and manage as a part of your SaaS product. On your software’s registration page, you collect whatever information is required to create an account for the customer. AWS Marketplace recommends collecting your customer’s email addresses if you plan to contact them through email for usage notifications.
The registration page needs to be able to identify and accept the x-amzn-marketplace-token token in the form data from AWS Marketplace with the customer’s identiﬁer for billing. It should then pass that token value to the AWS Marketplace Metering Service and AWS Marketplace Entitlement Service APIs to resolve for the unique customer identiﬁer and corresponding product code.


This solution creates a static HTML registration page hosted on S3 which takes the users inputs defined in the html form and submits them to marketplace/customer endpoint. This page is delivered via a CloudFront Distribution, which can be configured to use domain/CNAME by your choice. The POST request coming from AWS Marketplace is intercepted by the Edge `src/lambda-edge/edge-redirect.js`, which transforms the POST request to GET request, and passes the x-amzn-marketplace-token in the query string. The handler for the marketplace/customer endpoint is defined in the `src/register-new-subscriber.js` file, where we call the resolveCustomer and validate the token. If the token is valid the customer record is created in the `AWSMarketplaceSubscribers` DynamoDB table and the new customer data are stored.

*Grant access to new subscribers*

Once the `resolveCustomer` endpoint returns a successful response, you as the SaaS provider will need to provide access to the solution to the new subscriber. Based on the type of listing, contract or subscriptions, we have defined different conditions in the grant-revoke-access-to-product.js stream handler that is executed on adding new or updating existing rows.
In this implementation the Marketplace Tech Admin email address (defined as deployment parameter), will receive email notification when new services needs to be provisioned or existing services needs to be updated for a customer. AWS Marketplace strongly recommends automating the access and environment management which can be achieved by modifying the grant-revoke-access-to-product.js function. The property *successfully subscribed* is set when a successful response is returned by the SQS entitlement handler for SaaS Contract based listings or for Subscriptions baed listings, after receiving *subscribe-success* message from the Subscription SNS Topic in the subscription-sqs-handler.js.

*Updating entitlement levels to new and existing subscribers (SaaS Contracts only)*

If a customer’s entitlement changes, a message is received on the Entitlements SNS topic. On each new messag, the lambda function entitlement-sqs.js calls the marketplace EntitlementService and stores the response in the `AWSMarketplaceSubscribers` DynamoDB table. When the entitlement is update notification is sent to the MarketplaceTechAdmin email address.

*Revoking access to customers with expired contracts and cancelled subscriptions*

The revoke access logic is implemented in a similar manner as the grant access logic. The MarketplaceTechAdmin address receives an email when the contract expires or the subscription is cancelled. AWS Marketplace strongly recommends automating the access and environment management which can be achieved by modifying the grant-revoke-access-to-product.js function.

*Metering for usage*

For SaaS subscriptions listings, the SaaS vendor must meter for all usage and report the metering record to AWS Marketplace, which then bills customers based on the records provided. For SaaS contracts, the vendor only meter for usage beyond a customer’s contract entitlements. The SaaS provider must send AWS a quantity of usage accrued for each customer on the dimensions defined when you created your product, such as gigabytes transferred or hosts scanned in a given hour.


The MeteringSchedule CloudWatch Event rule is triggered every hour. The metering-hourly-job.js then queries all of the pending/unreported metering records from the `AWSMarketplaceMeteringRecords` table using the PendingMeteringRecordsIndex. All of the pending records are aggregated based on the customerIdentifier and dimension name, and sent to the SQSMetering queue. The records in the `AWSMarketplaceMeteringRecords` table are expected to be inserted programmatically by your SaaS application. In this case you will have to give permissions to the service in charge of collecting usage data in your existing SaaS product to be able to write to the `AWSMarketplaceMeteringRecords` table.
The lambda function metering-sqs.js sends all of the queued metering records to the AWS marketplace Metering API. After every call to the batchMeterUsage endpoint, the rows in the `AWSMarketplaceMeteringRecords` table are updated with the response returned from the Metering Service, which can be found in the metering_response field. If the request was unsuccessful the metering_failed value with be set to true and you will have to investigate the issue the error will be also stored in the metering_response field.


The lambda function metering-sqs.js sends all of the queued metering records to the AWS marketplace Metering API. After every call to the batchMeterUsage endpoint, the rows in the `AWSMarketplaceMeteringRecords` table are updated with the response returned from the Metering Service, which can be found in the metering_response field. If the request was unsuccessful the metering_failed value with be set to true and you will have to investigate the issue the error will be also stored in the metering_response field.

The new records in the `AWSMarketplaceMeteringRecords` table should be stored in the following format:


....
{
  "create_timestamp": 113123,
  "customerIdentifier": "ifAPi5AcF3",
  "dimension_usage": [
    {
      "dimension": "users",
      "value": 3
    },
     {
      "dimension": "admin_users",
      "value": 1
    }
  ],
  "metering_pending": "true"
}
....

Where the create_timestamp is the sort key and customerIdentifier is the partition key, both forming the Primary key.
After the record is submitted to AWS Marketplace API, it will be updated and entry will look like this.

....
{
   "create_timestamp": 113123,
   "customerIdentifier": "ifAPi5AcF3",
   "dimension_usage": [
     {
       "dimension": "admin_users",
       "value": 3
     }
   ],
   "metering_failed": false,
   "metering_response": "{\"Results\":[{\"UsageRecord\":{\"Timestamp\":\"2020-06-24T04:04:53.776Z\",\"CustomerIdentifier\":\"ifAPi5AcF3\",\"Dimension\":\"admin_users\",\"Quantity\":3},\"MeteringRecordId\":\"35155d37-56cb-423f-8554-5c4f3e3ff56d\",\"Status\":\"Success\"}],\"UnprocessedRecords\":[]}"
 }
....